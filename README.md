# AccessiBot

AI-powered web accessibility analysis with intelligent caching, dynamic batch processing, webhook CI/CD integration, multi-provider AI support with automatic fallback and cost optimization, plus design tool integrations for pre-development accessibility analysis — built on Encore.ts with a modern React frontend.

## Key Features

- **Automated accessibility analysis** for HTML content (URL or raw HTML)
- **Design Tool Integrations** with Figma, Sketch, and Adobe XD for pre-development analysis
- **Color contrast checking** and component accessibility validation in design files
- **Multi-Provider AI Enhancement** with OpenAI, Anthropic, and Google support
- **Automatic Provider Fallback** and cost optimization by selecting the most cost-effective provider
- Robust DB-backed caching with TTL and demo mode support
- Dynamic, priority-aware batch processing with adaptive sizing and rate-limiting
- Webhook ingestion (GitHub + generic) driving async analysis via Pub/Sub
- GitHub integration for automated PR creation with fixed content (demo-safe)
- Scheduled cache cleanup via Cron jobs (daily + weekly deep clean)
- Real-time analytics and monitoring dashboard (delivery, trends, performance)
- Provider management with stats, reset, and refresh capabilities
- Friendly UI (React, Tailwind v4, shadcn/ui, TanStack Query, lucide-react)

## Project Structure

- backend/
  - accessibot/
    - encore.service.ts
    - analyze.ts
    - **design-analysis.ts** (NEW: Design tool integrations)
    - **design-demo.ts** (NEW: Design integration status)
    - **ai-providers.ts** (Multi-provider AI management)
    - ai-service.ts (Enhanced with multi-provider support)
    - cache.ts
    - cache-migrations/
      - 1_create_cache_table.up.sql
    - rate-limiter.ts
    - rate-limiter-migrations/
      - 1_create_rate_limiter_table.up.sql
    - webhook.ts
    - webhook-processor.ts
    - webhook-status.ts
    - webhook-analytics.ts
    - webhook-docs.ts
    - webhook-migrations/
      - 1_create_webhook_analysis_table.up.sql
    - github.ts
    - cleanup.ts
    - cron-cleanup.ts
    - demo.ts (Enhanced with design tool info)
    - batch-stats.ts (Enhanced with provider stats)
    - **provider-management.ts** (Provider management endpoints)
- frontend/
  - App.tsx (Enhanced with design tool demo status)
  - components/
    - AccessibilityAnalyzer.tsx (Enhanced with design tools tab)
    - **DesignToolsIntegration.tsx** (NEW: Design tool analysis interface)
    - CacheStatus.tsx (Enhanced with provider management)
    - GitHubIntegration.tsx
    - WebhookStatus.tsx
    - WebhookAnalyticsDashboard.tsx
    - GlowCard.tsx
    - demo.tsx
    - ui/
      - squares-background.tsx
      - glowing-effect.tsx
      - fluid-blob.tsx

Notes:
- All backend code is implemented using Encore.ts under backend/.
- Frontend uses React + Vite + Tailwind v4 + shadcn/ui. Entry is frontend/App.tsx.
- Some framework scaffolding files (e.g., main.tsx, index.html, index.css) are auto-generated by the platform.

## Backend Overview (Encore.ts)

Service: accessibot

- Databases
  - ai-cache: Stores AI-generated fix snippets (ai_fixes table)
  - rate-limiter: Persists request timestamps for sliding-window rate limiting
  - webhook-analysis: Tracks webhook analyses and outcomes (webhook_analyses table)

- Pub/Sub
  - Topic: accessibility-analysis (at-least-once delivery)
  - Subscription: process-accessibility-analysis

- Cron Jobs
  - daily-cache-cleanup (2:00 AM UTC) → standard cleanup
  - weekly-cache-cleanup (Sunday 1:00 AM UTC) → deep cleanup

- Secrets (configured via Infrastructure tab)
  - **AI Providers**:
    - **OpenAIKey**: optional; enables OpenAI GPT-4 and GPT-4o-mini models
    - **AnthropicKey**: optional; enables Claude 3.5 Sonnet and Haiku models
    - **GoogleKey**: optional; enables Gemini 1.5 Pro and Flash models
  - **Design Tools**:
    - **FigmaToken**: optional; enables Figma file analysis and browsing
    - **SketchToken**: optional; enables Sketch file analysis (demo mode available)
    - **AdobeXDToken**: optional; enables Adobe XD file analysis (demo mode available)
  - **GitHub Integration**:
    - GitHubToken: optional; enables real PR creation; when missing, PR flow is simulated
    - WebhookSecret: optional; GitHub signature verification; if missing, validation is bypassed (demo-friendly)

### Design Tool Integrations

The system now supports design file analysis before development begins:

**Supported Platforms:**
- **Figma**: Full API integration with file browsing and component analysis
- **Sketch**: Basic analysis support (demo mode with mock data)
- **Adobe XD**: Basic analysis support (demo mode with mock data)

**Analysis Features:**
- **Color Contrast Checking**: Automatically detects text/background combinations and calculates WCAG contrast ratios
- **Component Accessibility Validation**: Checks for proper naming, semantic structure, and accessibility patterns
- **Touch Target Analysis**: Validates interactive elements meet minimum size requirements (44px/48dp)
- **Export Integration**: Provides implementation guidance for developers

**Design Analysis Types:**
- Color contrast validation with WCAG AA/AAA compliance checking
- Component naming and semantic structure validation
- Interactive element sizing and touch target analysis
- Design pattern accessibility review
- AI-enhanced recommendations for accessibility improvements

### Multi-Provider AI System

The system supports multiple AI providers with intelligent selection and fallback:

**Supported Providers:**
- **OpenAI**: GPT-4o ($15/1M tokens), GPT-4o-mini ($1.5/1M tokens)
- **Anthropic**: Claude 3.5 Sonnet ($15/1M tokens), Claude 3.5 Haiku ($1/1M tokens)  
- **Google**: Gemini 1.5 Pro ($3.5/1M tokens), Gemini 1.5 Flash ($0.375/1M tokens)

**Cost Optimization:**
- Automatically selects the most cost-effective provider for each request
- Considers task complexity (simple/medium/complex) when choosing models
- Tracks provider performance and costs for optimization
- Prefers cheaper models for simple tasks (alt text, labels)
- Uses more capable models for complex tasks (hierarchy, structure)

**Automatic Fallback:**
- Tries up to 3 providers per request if one fails
- Temporarily disables providers with high failure rates
- Auto-recovery after 5 minutes for disabled providers
- Graceful degradation to demo mode if all providers fail

**Provider Management:**
- Real-time statistics for each provider (success rate, cost, requests)
- Manual provider reset and configuration refresh
- Provider availability monitoring and management

### Demo Mode Behavior

- **AI**: If no AI provider keys are configured, AI responses are replaced with mock suggestions and results are still cached.
- **GitHub**: If GitHubToken is not provided, repository list and PR creation are simulated.
- **Design Tools**: If no design tool tokens are configured, mock design files and analysis results are provided.

## API Endpoints

All endpoints live under the accessibot service.

Public (expose: true) endpoints:

- **Analysis and AI status**
  - POST /analyze
    - Body: { url?: string; html?: string }
    - Returns: { issues: AccessibilityIssue[]; summary: { total, high, medium, low } }
  - GET /batch-processor/status
    - Returns current batch stats, priority queue summary, and provider statistics
  - GET /demo-mode
    - Returns flags for demo mode (AI/GitHub/Design Tools) and lists of available providers

- **Design Tool Integrations** (NEW)
  - POST /design/analyze
    - Body: { fileUrl?: string; fileId?: string; platform: "figma"|"sketch"|"adobe-xd"; nodeIds?: string[] }
    - Returns: { issues: DesignAccessibilityIssue[]; summary: {...}; fileInfo: {...} }
  - GET /design/files/:platform
    - Returns: { files: DesignFileInfo[]; platform: string }
  - GET /design/status
    - Returns design tool connection status

- **Provider Management**
  - GET /providers/stats
    - Returns comprehensive provider statistics and costs
  - POST /providers/reset
    - Re-enables all disabled providers
  - POST /providers/refresh
    - Refreshes provider configuration to detect new API keys

- **Cache management and stats**
  - POST /cleanup/cache
    - Body: { intervalDays?: number }
    - Triggers cache cleanup (custom interval or default)
  - GET /cache/stats
    - Returns cache statistics and current config

- **Webhooks**
  - POST /webhook/github
    - Expects GitHub push payload
    - Headers: X-Hub-Signature-256, X-GitHub-Event, X-GitHub-Delivery
    - Validates signature if WebhookSecret is configured
    - Publishes AccessibilityAnalysisRequest to topic
  - POST /webhook/generic
    - Generic provider push-like payload (repository + commits)
    - Publishes AccessibilityAnalysisRequest to topic
  - GET /webhook/docs
    - Returns webhook documentation, examples, and setup steps

- **Webhook analyses (status & analytics)**
  - GET /webhook/analyses
    - Query: page, limit, status, repository
    - Returns paginated analysis results
  - GET /webhook/analyses/:webhookId
    - Returns a single analysis by webhook ID
  - GET /webhook/stats
    - Aggregate counts, PR created, averages, last analysis
  - POST /webhook/analyses/:webhookId/retry
    - Resets failed analysis to pending (demo-only requeue semantics)
  - GET /webhook/analytics
    - Query: startDate, endDate, repository
    - Returns delivery analytics, repo stats, issue trends, fix analytics, processing times
  - GET /webhook/performance
    - Real-time metrics snapshot (current hour, last 24h, today's success rate, etc.)

- **GitHub integration**
  - GET /github/repositories
    - Lists repositories for authenticated user (or mock list in demo)
  - POST /github/pull-request
    - Body: { repoOwner, repoName, fixes: [{ fileName, content, issues[] }], title?, description? }
    - Creates a PR on a new branch with provided content (simulated in demo)

## Design Tool Integration Workflow

1. **Connect Design Tools**: Configure API tokens in Infrastructure tab for Figma, Sketch, or Adobe XD
2. **Browse Design Files**: View and select design files from connected platforms
3. **Analyze Designs**: Run accessibility analysis on design files before development
4. **Review Issues**: See color contrast problems, component naming issues, and accessibility violations
5. **Get Implementation Guidance**: Receive AI-enhanced recommendations for accessible development
6. **Integrate with Development**: Use analysis results to guide accessible implementation

## AI, Caching, and Rate Limiting

- **Multi-Provider AI Service**
  - Supports OpenAI, Anthropic, and Google AI providers
  - Automatic cost optimization by selecting the cheapest suitable provider
  - Task complexity analysis (simple/medium/complex) for model selection
  - Automatic fallback between providers on failures
  - Provider performance tracking and temporary disabling of unreliable providers
  - Batch processing with dynamic batch size and delay to target response time
  - Priority queuing (high/medium/low severity → higher priority)
  - Robust parsing and error handling for AI responses

- **Design Analysis**
  - Figma API integration for live file analysis
  - Color contrast calculation using WCAG standards
  - Component accessibility pattern recognition
  - Touch target size validation
  - AI-enhanced design recommendations

- Cache
  - DB table: ai_fixes(issue_hash, fixed_code_snippet, created_at)
  - Hashing strategy: deterministic hash over issue type/element/description
  - TTL-based lookup; configurable defaults in cache.ts
  - Endpoints and cron jobs support cleanup and visibility into cache state

- Rate Limiter
  - Sliding window using DB table rate_limit_requests
  - Default: 50 requests/hour for AI usage (applied to all providers)
  - Prevents exceeding configured budget; exposes reset and remaining

## Webhook Processing Pipeline

1. Webhook received (GitHub or generic) and validated (if WebhookSecret set)
2. Changed files filtered to likely HTML/UI sources
3. AccessibilityAnalysisRequest published to topic
4. Subscription handler:
   - Persists initial analysis record (processing)
   - Generates demo HTML (for demo purposes) and runs analyzeHTML
   - Multi-provider AI enhancement of issues with cost optimization
   - Optionally creates a PR when high-severity issues exist
   - Updates analysis record (completed/failed) with counts and PR URL

Note: In this demo, file contents are simulated. Integrating real repository file fetch is an extension point.

## Frontend

- **AccessibilityAnalyzer** (Enhanced)
  - URL/HTML analysis
  - **Design Tool Integration** tab for analyzing design files
  - Displays issues and AI-enhanced fixes with provider information
  - GitHub PR creation UI
  - Cache status and batch processor stats

- **DesignToolsIntegration** (NEW)
  - Platform selection (Figma, Sketch, Adobe XD)
  - Design file browsing and selection
  - Color contrast analysis with visual representation
  - Component accessibility validation
  - AI-enhanced implementation guidance

- **CacheStatus** (Enhanced)
  - Multi-provider AI statistics with cost tracking
  - Provider management (reset/refresh)
  - Individual provider performance metrics
  - Cache statistics and cleanup controls
  - Batch processor monitoring

- **WebhookStatus**
  - Overview metrics, recent analyses with filters and retry
  - Analytics dashboard with trends, repository performance, processing times
  - Docs and setup guidance for webhooks

- **UI/UX**
  - Tailwind v4 and shadcn/ui for components
  - Animated backgrounds (squares), glowing accent effects
  - Responsive design, subtle animations, dark-friendly color tokens

## Configuration

Configure secrets in the Infrastructure tab:

- **AI Providers** (at least one required for AI features):
  - OpenAIKey: Enables OpenAI GPT-4o and GPT-4o-mini models
  - AnthropicKey: Enables Claude 3.5 Sonnet and Haiku models
  - GoogleKey: Enables Gemini 1.5 Pro and Flash models

- **Design Tools** (optional, demo mode available):
  - FigmaToken: Enables Figma file analysis and browsing
  - SketchToken: Enables Sketch file analysis (limited support)
  - AdobeXDToken: Enables Adobe XD file analysis (limited support)

- **GitHub Integration**:
  - GitHubToken: Enables real repository listing and PR creation; otherwise simulated
  - WebhookSecret: Enables GitHub webhook signature validation (X-Hub-Signature-256)

If no provider secrets are set, the system gracefully falls back to demo mode.

## Cost Optimization Features

- **Provider Selection Algorithm**: Automatically chooses the most cost-effective provider based on:
  - Task complexity (simple tasks use cheaper models)
  - Provider reliability (success rate tracking)
  - Current provider availability
  - Token requirements vs. provider limits

- **Cost Tracking**: Real-time cost monitoring per provider with total spend visibility

- **Intelligent Fallback**: Falls back to cheaper providers when premium providers fail

- **Performance-Based Selection**: Temporarily disables unreliable providers to avoid wasted costs

## Design Tool Features

- **Pre-Development Analysis**: Catch accessibility issues before code is written
- **Color Contrast Validation**: WCAG AA/AAA compliance checking with visual feedback
- **Component Review**: Semantic naming and structure validation
- **Touch Target Analysis**: Interactive element sizing validation
- **Cross-Platform Support**: Figma, Sketch, and Adobe XD integration
- **Implementation Guidance**: AI-enhanced recommendations for accessible development

## Extensibility Notes

- Additional design tool integrations can be added to design-analysis.ts
- Color contrast algorithms can be enhanced for more complex scenarios
- Component accessibility patterns can be expanded based on design system needs
- Additional AI providers can be easily added to ai-providers.ts
- Cost optimization algorithms can be tuned based on usage patterns
- Provider-specific features (like function calling) can be added per provider
- Real repository file fetching in webhook-processor.ts can be added using provider APIs
- Authentication is intentionally omitted; add it only if needed
- Additional issue detectors can be added to analyzeHTML
- AI prompt construction/parsing logic is modularized for batch/individual flows

## Limitations

- Sketch and Adobe XD integrations are limited to demo mode (API limitations)
- Design analysis is based on color/structure inspection, not interactive behavior
- Webhook processor uses sample HTML (demo) instead of live repo content
- No authentication by default (by design)
- AI output is best-effort; always validate changes before merging
- Provider rate limits are managed globally, not per-provider

## Types and Contracts

The backend uses native TypeScript interfaces for request/response schemas, ensuring type safety in the frontend via ~backend imports. Examples:

- AccessibilityIssue, DesignAccessibilityIssue (analyze.ts, design-analysis.ts)
- ColorContrastIssue, DesignFileInfo (design-analysis.ts)
- BatchProcessorInfo with provider stats (batch-stats.ts)
- ProviderStatsResponse (provider-management.ts)
- WebhookAnalysisResult (webhook-processor.ts)
- GitHubRepo, CreatePullRequestRequest/Response (github.ts)
- Webhook payload contracts (webhook.ts)

## Safety and Security

- GitHub webhook signature validation (HMAC-SHA256) when WebhookSecret is configured
- Design tool API token security through Encore.ts secret management
- Robust API error handling via Encore.ts APIError
- No secrets in code; all secrets managed through the platform's Infrastructure tab
- Provider isolation: failures in one provider don't affect others
- Cost controls through rate limiting and provider management
- Input validation for design file URLs and parameters
